openapi: 3.0.3
info:
  title: VestLab Finance News API
  description: |
    基于 Cloudflare Workers 的财经新闻聚合与 AI 分析后端。
    - 自动抓取 Bloomberg / WSJ RSS 新闻
    - AI 生成每日美股市场总结报告
    - AI 翻译新闻标题和描述为中文
    - 全球主要股市指数实时数据（Yahoo Finance）
  version: 1.1.0
  contact:
    name: VestLab

servers:
  - url: https://vestlab-finance-news.{account}.workers.dev
    description: Production (Cloudflare Workers)
    variables:
      account:
        default: your-account
  - url: http://localhost:8787
    description: Local Development

tags:
  - name: Public API
    description: 公开数据接口
  - name: Triggers
    description: 手动触发任务（调试/运维用）

paths:
  /:
    get:
      tags: [Public API]
      summary: 健康检查
      operationId: healthCheck
      responses:
        '200':
          description: Worker 运行正常
          content:
            text/plain:
              schema:
                type: string
                example: VestLab Finance News Worker (Hono)

  /api/news:
    get:
      tags: [Public API]
      summary: 获取最新新闻列表
      description: 返回最近的新闻列表，包含中文翻译（如有）。按发布时间倒序排列。
      operationId: getLatestNews
      parameters:
        - name: limit
          in: query
          required: false
          description: 返回条数，默认 50
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
      responses:
        '200':
          description: 新闻列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NewsItemWithTranslation'

  /api/daily-summary:
    get:
      tags: [Public API]
      summary: 获取每日市场总结报告
      description: |
        获取指定日期的 AI 生成市场总结报告。
        - 每天 21:30 UTC（美股收盘后 30 分钟）自动生成。
        - 报告包含从 Yahoo Finance 获取的真实指数数据。
        - 如果当天没有报告，返回提示信息。
      operationId: getDailySummary
      parameters:
        - name: date
          in: query
          required: false
          description: 日期，格式 YYYY-MM-DD，默认为今天
          schema:
            type: string
            format: date
            example: '2026-02-13'
      responses:
        '200':
          description: 每日总结
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailySummaryResponse'

  /api/market-data:
    get:
      tags: [Public API]
      summary: 获取市场指数数据
      description: |
        获取全球主要股市指数数据。
        - 不传 date 参数时返回最新数据。
        - 覆盖指数：标普500、纳斯达克、道琼斯、上证综指、深证成指、恒生、日经225、富时100、DAX、CAC40、ASX200、KOSPI。
        - 未来支持大宗商品和个股。
      operationId: getMarketData
      parameters:
        - name: date
          in: query
          required: false
          description: 日期，格式 YYYY-MM-DD，不传则返回最新数据
          schema:
            type: string
            format: date
            example: '2026-02-13'
      responses:
        '200':
          description: 市场指数数据
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketDataResponse'

  /trigger-fetch:
    get:
      tags: [Triggers]
      summary: 手动触发新闻抓取
      description: 立即从 Bloomberg 和 WSJ 抓取 RSS 新闻并存储。
      operationId: triggerFetch
      responses:
        '200':
          description: 抓取完成
          content:
            text/plain:
              schema:
                type: string
                example: Fetch triggered

  /trigger-summary:
    get:
      tags: [Triggers]
      summary: 手动触发每日总结 + 翻译
      description: |
        手动生成今日市场总结报告，并触发未翻译新闻的中文翻译。
        如果今日报告已存在，则跳过生成。
      operationId: triggerSummary
      responses:
        '200':
          description: 总结和翻译任务已触发
          content:
            text/plain:
              schema:
                type: string
                example: Daily Briefing (and Translation) generation triggered

  /trigger-translation:
    get:
      tags: [Triggers]
      summary: 手动触发翻译
      description: 翻译最近 24 小时内未翻译的新闻标题和描述为中文。
      operationId: triggerTranslation
      responses:
        '200':
          description: 翻译任务已触发
          content:
            text/plain:
              schema:
                type: string
                example: Translation generation triggered

  /trigger-market-fetch:
    get:
      tags: [Triggers]
      summary: 手动触发市场数据抓取
      description: |
        从 Yahoo Finance 抓取全球主要指数数据。
        - 首次调用会执行冷启动，拉取近 90 天历史数据。
        - 后续调用只更新当日最新报价。
      operationId: triggerMarketFetch
      responses:
        '200':
          description: 市场数据抓取结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  action:
                    type: string
                    enum: [cold_start, daily_update, error]
                    description: 执行的操作类型
                    example: daily_update
                  saved:
                    type: integer
                    description: 保存的记录数
                    example: 12
                  error:
                    type: string
                    nullable: true
                    description: 错误信息（仅 action=error 时有值）
                    example: null

  /trigger-polymarket-snapshot:
    get:
      tags: [Triggers]
      summary: 手动触发 Polymarket 快照
      description: |
        手动抓取 Polymarket 宏观预测市场数据并保存快照到数据库。
        用于记录每日概率变化历史。
      operationId: triggerPolymarketSnapshot
      responses:
        '200':
          description: 快照保存成功
          content:
            text/plain:
              schema:
                type: string
                example: Polymarket snapshot triggered

components:
  schemas:
    NewsItemWithTranslation:
      type: object
      description: 新闻条目（含翻译）
      properties:
        id:
          type: string
          format: uuid
          description: 新闻 UUID
          example: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
        source:
          type: string
          description: 新闻来源
          enum: [Bloomberg, WSJ Markets, WSJ Economy, WSJ World]
          example: Bloomberg
        title:
          type: string
          description: 原始标题（英文）
          example: 'S&P 500 Rises as Tech Stocks Rally'
        url:
          type: string
          format: uri
          description: 原文链接
          example: 'https://www.bloomberg.com/news/...'
        published_at:
          type: string
          format: date-time
          description: 发布时间
          example: '2026-02-13T21:00:00Z'
        author:
          type: string
          nullable: true
          description: 作者
        image_url:
          type: string
          format: uri
          nullable: true
          description: 配图 URL
        tags:
          type: string
          nullable: true
          description: 标签（逗号分隔）
        description:
          type: string
          nullable: true
          description: RSS 简述（英文）
        raw_content:
          type: string
          nullable: true
          description: 全文内容（如有爬取）
        crawled_at:
          type: string
          format: date-time
          description: 抓取时间
        translated_title:
          type: string
          nullable: true
          description: 中文标题
          example: '科技股反弹推动标普500指数上涨'
        translated_content:
          type: string
          nullable: true
          description: 中文简述
          example: '受科技板块强劲表现带动，标普500指数周三收涨...'

    MarketDataItem:
      type: object
      description: 市场数据条目（指数/个股/商品）
      properties:
        id:
          type: integer
          description: 自增 ID
        symbol:
          type: string
          description: Yahoo Finance 代码
          example: '^GSPC'
        name:
          type: string
          description: 中文名称
          example: '标普500'
        type:
          type: string
          enum: [index, stock, commodity]
          description: 数据类型
          example: index
        price:
          type: number
          nullable: true
          description: 收盘/最新价
          example: 6142.30
        change_amount:
          type: number
          nullable: true
          description: 涨跌额
          example: 50.12
        change_percent:
          type: number
          nullable: true
          description: 涨跌幅 (%)
          example: 0.82
        day_high:
          type: number
          nullable: true
          description: 日内最高价
        day_low:
          type: number
          nullable: true
          description: 日内最低价
        previous_close:
          type: number
          nullable: true
          description: 前收盘价
        market_time:
          type: string
          format: date-time
          nullable: true
          description: 数据时间（交易所当地时间）
        fetched_at:
          type: string
          format: date-time
          description: 抓取时间 (UTC)
        date:
          type: string
          format: date
          description: 日期
          example: '2026-02-13'

    MarketDataResponse:
      type: object
      description: 市场数据响应
      properties:
        count:
          type: integer
          description: 返回的数据条数
          example: 12
        data:
          type: array
          items:
            $ref: '#/components/schemas/MarketDataItem'
      required:
        - count
        - data

    DailySummaryResponse:
      type: object
      description: 每日市场总结响应
      properties:
        date:
          type: string
          format: date
          description: 日期
          example: '2026-02-13'
        summary:
          type: string
          description: AI 生成的市场总结报告（中文），如无则返回提示
          example: |
            ## 今日美股市场总结

            **宏观综述**：今日市场整体呈现震荡上行态势...

            **板块分析**：科技板块表现强势...

            **关键事件**：...

            **明日展望**：...
      required:
        - date
        - summary

